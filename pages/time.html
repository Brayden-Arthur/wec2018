<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'/>
  <title>Innoti.me</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' href='../style.css'/>
  <style>
    #timer {
      font-size: 500%;
    }
    div {
      background: rgb(3, 148, 180);
      padding: 10px 15px;
      cursor: pointer;
    }
  </style>
</head>
<body></body>
<script>
const timer = document.createElement('div')
timer.id = 'timer'

const pauseButton = document.createElement('div')
pauseButton.innerText = 'Start'
const resetButton = document.createElement('div')
resetButton.innerText = 'Reset'

const input = document.createElement('input')
input.placeholder = '20:00'

const notice = document.createElement('span')

// initially load paused
let paused = true
// holds the timeout for the next tick
let next
// the audio file to play when the timer completes
const audio = new Audio('TimerDoneBell.mp3')

const timerTime = localStorage.getItem('timerTime')
if (timerTime) {
  timer.innerHTML = timerTime
} else {
  timer.innerHTML = '00:00'
}
const inputTime = localStorage.getItem('inputTime')
if (inputTime) {
  input.value = inputTime
}
// else use placeholder

function pause(bool) {
  console.log('pause', bool)
  if (paused === bool) {
    return
  }
  paused = bool
  const text = bool ? 'Start' : 'Stop'
  pauseButton.innerText = text
  tick()
}

input.addEventListener('keyup', event => {
  pause(true)
  if (/^\d{1,2}:\d{2}$/.test(input.value)) {
    notice.innerText= ''
    localStorage.setItem('savedTime', input.value)
    reset()
  } else {
    notice.innerText = 'Please use (M)M:SS format'
  }
})

pauseButton.addEventListener('click', event => {
  pause(!paused)
})

function reset() {
  // clearTimeout(next)
  // tick()
  timer.innerHTML = localStorage.getItem('savedTime')
  notice.innerText = ''
}
resetButton.addEventListener('click', reset)

function tick() {
  if (paused) {
    return
  }
  const now = timer.innerHTML
  let [minutes, seconds] = now.split(':').map(x => {
    return parseInt(x) || 0
  })
  if (--seconds < 0) {
    seconds = '59'
    minutes--
  }
  if (minutes < 0) {
    pause(true)
    audio.play()
    const dateText = (new Date()).toLocaleString()
    notice.innerText = `Timer completed at ${dateText}`
    return
  }
  if (seconds.toString().length == 1) {
    seconds = '0' + seconds
  }
  if (minutes.toString().length == 1) {
    minutes = '0' + minutes
  }
  const newTime = `${minutes}:${seconds}`
  timer.innerHTML = newTime
  localStorage.setItem('time', newTime)
  next = setTimeout(tick, 1000)
}

// the iframe has loaded
const body = document.body
const elements = [timer, pauseButton, resetButton, input, notice]
for (elem of elements) {
  body.appendChild(elem)
}
</script>
</html>